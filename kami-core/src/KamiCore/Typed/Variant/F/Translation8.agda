
{-# OPTIONS --allow-unsolved-metas --rewriting #-}

module KamiCore.Typed.Variant.F.Translation8 where

open import Agora.Conventions hiding (m ; n ; k ; _‚à£_ ; _‚äî_ ; ls)
open import Agora.Data.Product.Definition
open import Agora.Order.Preorder
open import Agora.Order.Lattice
open import Agora.Category.Std.Category.Definition
open import Agora.Category.Std.2Category.Definition
open import KamiTheory.Order.StrictOrder.Base
open import KamiTheory.Data.UniqueSortedList.Definition
open import KamiTheory.Data.List.Definition
open import KamiTheory.Main.Generic.ModeSystem.ModeSystem.Definition
open import KamiTheory.Main.Generic.ModeSystem.ModeSystem.Instance.2Category


open import KamiTheory.Main.Generic.ModeSystem.2Graph.Definition renaming (_‚óÜ_ to _‚óÜ'_ ; id to id')

open import KamiTheory.Order.StrictOrder.Base
open import KamiTheory.Basics hiding (_‚ãÜ_)

module _ {A B : ùí∞ ùëñ} where
  transp : A ‚â° B -> A -> B
  transp refl-‚â° a = a

  -- cong-‚â° 



module Translation (n : ‚Ñï) where
-- (P : Preorder ùëñ) {{_ : hasDecidableEquality ‚ü® P ‚ü©}} {{_ : ‚àÄ{a b : ‚ü® P ‚ü©} -> isProp (a ‚â§ b)}} where

  P : Preorder _
  P = ùí´·∂†‚Å±‚Åø (ùîΩ n)

  instance
    hasDecidableEquality:P : hasDecidableEquality ‚ü® P ‚ü©
    hasDecidableEquality:P = {!!}

  instance
    isProp:‚â§ : ‚àÄ{a b : ‚ü® P ‚ü©} -> isProp (a ‚â§ b)
    isProp:‚â§ = {!!}

  -- Getting the mode system
  import KamiTheory.Main.Generic.ModeSystem.2Graph.Example as 2GraphExample
  import KamiTheory.Main.Generic.ModeSystem.2Cell.Example as 2CellExample
  import KamiTheory.Main.Generic.ModeSystem.2Cell.Definition as 2CellDefinition
  import KamiTheory.Main.Generic.ModeSystem.2Cell.Linear as 2CellLinear
  open 2CellDefinition.2CellDefinition hiding (id)
  open import KamiTheory.Main.Generic.ModeSystem.ModeSystem.Example
  open SendReceiveNarrow-ModeSystem P {{it}} {{it}}
  open 2GraphExample.SendReceiveNarrow-2Graph P
  open 2CellLinear.2CellLinear SRN
  -- open 2CellExample.SendReceiveNarrow-2Cells P {{it}} {{it}}


  -- Instantiating MTT with the 2category generated from the modesystem
  open import KamiCore.Typed.Variant.F.Definition3

  instance
    Param : MTTÍü≥ _
    Param = record
      { ùìÇ = Mode SRN-ModeSystem
      ; isCategory:ùìÇ = isCategory:byModeSystem SRN-ModeSystem
      ; is2Category:ùìÇ = is2Category:byModeSystem SRN-ModeSystem
      }


  open Definition-MTTÍü≥ {{Param}}
    renaming (ModeHom to ModeHom' ; _‚ä¢_ to _‚ä¢'_)

  instance
    isCategoryData:ModeHom : isCategoryData (Mode SRN-ModeSystem) ModeHom'
    isCategoryData:ModeHom = HomData {{isCategory:ùìÇ {{Param}}}}

  instance
    isCategory:ModeHom : isCategory (Mode SRN-ModeSystem)
    isCategory:ModeHom = record { Hom = ModeHom' }

  instance
    is2Category:ModeHom : is2Category ‚Ä≤(Mode SRN-ModeSystem)‚Ä≤
    is2Category:ModeHom = is2Category:ùìÇ {{Param}}


  -- Instantiating the target language with the preorder
  open import KamiCore.Typed.Variant.F.Model9

  œÅ : isProcessSet _
  œÅ = record { Proc = ùîΩ n }

  open IR {{œÅ}}
    renaming (Ctx to Ctx' ; Mode to Mode')


  private variable
    a b c : Mode SRN-ModeSystem
    Œº ŒΩ Œ∑ œâ : ModeHom' a b

  data isBroadcast : ‚àÄ{a b} -> {Œº ŒΩ : ModeHom' a b} -> Œº ‚üπ ŒΩ -> ùí∞‚ÇÄ where
  -- data isBroadcast {a b} : {Œº ŒΩ : ModeHom' a b} -> Œº ‚üπ ŒΩ -> ùí∞‚ÇÄ where
    -- br : ‚àÄ{U œï‚ÇÄ œï‚ÇÅ} -> isBroadcast [ (incl []) ‚à£ incl (incl (œï‚ÇÄ ‚åü[ recv U ]‚åû (œï‚ÇÅ ‚åü)) ‚à∑ []) ]
    br : ‚àÄ{U} -> isBroadcast [ (incl []) ‚à£ incl (incl (id' ‚åü[ recv U ]‚åû (id' ‚åü)) ‚à∑ []) ]



  --------------------------------------------------
  -- Translating MTT terms into a form where the
  -- contexts only have single restrictions form.
  data isCtx‚ÇÅ : Ctx a -> ùí∞‚ÇÄ where
    Œµ : isCtx‚ÇÅ {a = a} Œµ
    stepVar : {Œì : Ctx b} -> isCtx‚ÇÅ Œì -> {A : ‚ä¢Type a} -> {Œº : a ‚ü∂ b} -> isCtx‚ÇÅ (Œì ‚àô‚üÆ A ‚à£ Œº ‚üØ)
    stepRes : {Œì : Ctx b} -> isCtx‚ÇÅ Œì -> {Œº : BaseModeHom-SRN a b} -> isCtx‚ÇÅ (Œì ‚àô! (Œº ‚®æ id))


  addRes : (Œº : a ‚ü∂ b) -> ‚àë isCtx‚ÇÅ {a = b} -> ‚àë isCtx‚ÇÅ {a = a}
  addRes id' Œì = Œì
  addRes (x ‚®æ Œº) Œì =
    let Œì' , Œì'p = addRes Œº Œì
    in Œì' ‚àô! (x ‚®æ id') , stepRes Œì'p

  toCtx‚ÇÅ : Ctx a -> ‚àë isCtx‚ÇÅ {a = a}
  toCtx‚ÇÅ Œµ = Œµ , Œµ
  toCtx‚ÇÅ (Œì ‚àô‚üÆ x ‚à£ x‚ÇÅ ‚üØ) =
    let Œì , Œìp = toCtx‚ÇÅ Œì
    in Œì ‚àô‚üÆ x ‚à£ x‚ÇÅ ‚üØ , stepVar Œìp
  toCtx‚ÇÅ (Œì ‚àô! Œº) = addRes Œº (toCtx‚ÇÅ Œì)

  -- to‚ÇÅ-Var : ‚àÄ{Œì : Ctx a} {A : ‚ä¢Type a} -> Œì ‚ä¢ A -> fst (toCtx‚ÇÅ Œì) ‚ä¢ 

  --------------------------------------------------
  -- Translating MTT terms into a form where the
  -- contexts only have {Ôº†j}{‚óª} form.



  --------------------------------------------------
  -- An MTT version which has only single 
  module _ where
    private variable
      Œì : Ctx a
      A B : ‚ä¢Type a

    data _‚ä¢_ : Ctx a -> ‚ä¢Type a -> ùí∞‚ÇÄ where
      var : ‚àÄ{Œº : _ ‚ü∂ b} -> Œì ‚ä¢Var‚üÆ A ‚à£ Œº ‚áí Œ∑ ‚üØ -> (Œ± : Œº ‚üπ Œ∑) -> Œì ‚ä¢ A
      tt : Œì ‚ä¢ Unit

      -- modalities
      mod : ‚àÄ Œº -> Œì ‚àô! (Œº ‚®æ id') ‚ä¢ A -> Œì ‚ä¢ ‚ü® A ‚à£ Œº ‚®æ id' ‚ü©
      letmod : ‚àÄ(Œº : BaseModeHom-SRN a b) -> (ŒΩ : b ‚ü∂ c)
            -> Œì ‚àô! ŒΩ ‚ä¢ ‚ü® A ‚à£ Œº ‚®æ id' ‚ü©
            -> Œì ‚àô‚üÆ A ‚à£ Œº ‚®æ ŒΩ ‚üØ ‚ä¢ B
            -> Œì ‚ä¢ B

      letmod' : ‚àÄ(Œº : BaseModeHom-SRN a b)
            -> Œì ‚ä¢ ‚ü® A ‚à£ Œº ‚®æ id' ‚ü©
            -> Œì ‚àô‚üÆ A ‚à£ Œº ‚®æ id' ‚üØ ‚ä¢ B
            -> Œì ‚ä¢ B

      -- explicit transformations
      trans : ‚àÄ {Œº ŒΩ : a ‚ü∂ b} -> (Œ± : Œº ‚üπ ŒΩ) -> isBroadcast Œ± -> Œì ‚ä¢ ‚ü® A ‚à£ Œº ‚ü© -> Œì ‚ä¢ Tr ‚ü® A ‚à£ ŒΩ ‚ü©

      -- transformations monad
      pure : Œì ‚ä¢ A -> Œì ‚ä¢ Tr A
      seq : ‚àÄ{A : ‚ä¢Type a} -> Œì ‚ä¢ Tr A -> Œì ‚àô‚üÆ A ‚à£ id ‚üØ ‚ä¢ B -> Œì ‚ä¢ Tr B

      -- functions
      lam : Œì ‚àô‚üÆ A ‚à£ id' ‚üØ ‚ä¢ B -> Œì ‚ä¢ ‚üÆ A ‚à£ id' ‚üØ‚áí B

      -- app : Œì ‚ä¢ ‚üÆ A ‚à£ Œº ‚üØ‚áí B -> Œì ‚àô! Œº ‚ä¢ A -> Œì ‚ä¢ B
      app : Œì ‚ä¢ ‚üÆ A ‚à£ id' ‚üØ‚áí B -> Œì ‚ä¢ A -> Œì ‚ä¢ B

    -- shift-Ôº† : ‚àÄ{i} -> {A : ‚ä¢Type a} -> (Œì ‚àô! (`Ôº†` i ‚®æ id')) ‚àô‚üÆ A ‚à£ Œº ‚üØ ‚ä¢ B -> (Œì ‚àô‚üÆ A ‚à£ Œº ‚óÜ (`Ôº†` i ‚®æ id') ‚üØ ‚àô! (`Ôº†` i ‚®æ id')) ‚ä¢ B
    -- shift-Ôº† = {!!}

    shift-Ôº† : ‚àÄ{i} -> {A : ‚ä¢Type ‚ñ≤} -> (Œì ‚àô! (`Ôº†` i ‚®æ id')) ‚àô‚üÆ A ‚à£ id' ‚üØ ‚ä¢ B -> (Œì ‚àô‚üÆ ‚ü® A ‚à£ (`Ôº†` i ‚®æ id') ‚ü© ‚à£ id' ‚üØ ‚àô! (`Ôº†` i ‚®æ id')) ‚ä¢ B
    shift-Ôº† = {!!}

    split-path : ‚àÄ{Œºs : ModeHom' b c} -> ‚àÄ{Œº} -> ‚àÄ{A : ‚ä¢Type a} -> Œì ‚àô! (Œº ‚®æ Œºs) ‚ä¢ A -> (Œì ‚àô! Œºs) ‚àô! (Œº ‚®æ id') ‚ä¢ A
    split-path = {!!}

    id-annotate : ‚àÄ{Œì : Ctx a} -> Œì ‚àô‚üÆ A ‚à£ Œº ‚üØ ‚ä¢ B -> Œì ‚àô‚üÆ ‚ü® A ‚à£ Œº ‚ü© ‚à£ id' ‚üØ ‚ä¢ B
    id-annotate = {!!}



  data isCtx‚ÇÇ : Ctx a -> ùí∞‚ÇÄ where
    Œµ : isCtx‚ÇÇ {a = a} Œµ
    stepVar : {Œì : Ctx ‚óØ} -> isCtx‚ÇÇ Œì -> {A : ‚ä¢Type a} -> {Œº : a ‚ü∂ ‚óØ} -> isCtx‚ÇÇ (Œì ‚àô‚üÆ A ‚à£ Œº ‚üØ)
    stepRes : {Œì : Ctx a} -> isCtx‚ÇÇ Œì -> isCtx‚ÇÇ (Œì ‚àô! Œº)
    -- stepRes-‚óª : {Œì : Ctx ‚ñ≤} -> isCtx‚ÇÇ Œì -> isCtx‚ÇÇ (Œì ‚àô! (`[]` ‚®æ id))
    -- stepRes-Ôº† : {Œì : Ctx ‚óØ} -> ‚àÄ{p} -> isCtx‚ÇÇ Œì -> isCtx‚ÇÇ (Œì ‚àô! (`Ôº†` p ‚®æ id))







  ‚¶ã_‚¶å-Mode : Mode SRN-ModeSystem -> Mode'
  ‚¶ã ‚ñ≤ ‚¶å-Mode = ‚ñ≤
  ‚¶ã ‚óØ ‚¶å-Mode = ‚óØ

  F-Type : (ModeHom' a b) -> Type ‚¶ã a ‚¶å-Mode -> Type ‚¶ã b ‚¶å-Mode
  F-Type id' x = x
  F-Type (`Ôº†` U ‚®æ Œº) x = F-Type Œº (x Ôº† U)
  F-Type (`[]` ‚®æ Œº) x = F-Type Œº (‚óª x)

  F-Type-Proof : (Œº : ModeHom' a b) -> ‚àÄ{X : Type ‚¶ã a ‚¶å-Mode} -> isClosed X -> isClosed (F-Type Œº X)
  F-Type-Proof Œº Xp = {!!}

  F-Type-map : ‚àÄ{X} {Œº : ModeHom' a b} {ŒΩ : ModeHom' b c} -> F-Type (Œº ‚óÜ ŒΩ) X ‚â° F-Type ŒΩ (F-Type Œº X)
  F-Type-map {Œº = id'} = refl-‚â°
  F-Type-map {Œº = `Ôº†` U ‚®æ Œº} = F-Type-map {Œº = Œº}
  F-Type-map {Œº = `[]` ‚®æ Œº} = F-Type-map {Œº = Œº}


  ‚¶ã_‚¶å-Type : ‚ä¢Type a -> Type ‚¶ã a ‚¶å-Mode
  ‚¶ã ‚ü® X ‚à£ Œº ‚ü© ‚¶å-Type = F-Type Œº ‚¶ã X ‚¶å-Type
  ‚¶ã Unit ‚¶å-Type = Unit
  ‚¶ã Tr X ‚¶å-Type = Tr ‚¶ã X ‚¶å-Type
  ‚¶ã ‚üÆ X ‚à£ Œº ‚üØ‚áí Y ‚¶å-Type = F-Type Œº ‚¶ã X ‚¶å-Type ‚áí ‚¶ã Y ‚¶å-Type
  ‚¶ã Either x x‚ÇÅ ‚¶å-Type = {!!}
  ‚¶ã Lst x ‚¶å-Type = {!!}


  TargetCtx : Mode SRN-ModeSystem -> ùí∞ _
  TargetCtx ‚ñ≤ = Ctx' √ó ‚ü® P ‚ü©
  TargetCtx ‚óØ = Ctx'

  addRestr : (Œº : ModeHom' a b) -> TargetCtx b -> TargetCtx a
  addRestr id' Œì = Œì
  addRestr (`Ôº†` U ‚®æ Œº) Œì = addRestr Œº Œì , U
  addRestr (`[]` ‚®æ Œº) Œì = let Œì' , U = addRestr Œº Œì in Œì' ,[ U ]

  transl-Ctx : ‚àÄ{Œº : ModeHom' a ‚óØ} -> (Œì : CtxExt Œº) -> isCtx‚ÇÇ (Œµ ‚ãÜ Œì) -> TargetCtx a
  transl-Ctx Œµ Œìp = Œµ
  transl-Ctx (Œì ‚àô‚üÆ x ‚à£ Œº ‚üØ) (stepVar Œìp) = transl-Ctx Œì Œìp , F-Type Œº ‚¶ã x ‚¶å-Type
  transl-Ctx (_‚àô!_ Œì Œº) (stepRes Œìp) = addRestr Œº (transl-Ctx Œì Œìp)
    -- let Œì' , i = transl-Ctx Œì Œìp
    -- in {!!}
  -- transl-Ctx (_‚àô!_ {‚óØ} Œì Œº) (stepRes Œìp) = {!!}
  -- transl-Ctx (Œì ‚àô! (`[]` ‚®æ id')) (stepRes-‚óª Œìp) = let Œì , i = transl-Ctx Œì Œìp in Œì ,[ i ]
  -- transl-Ctx (Œì ‚àô! (`Ôº†` i ‚®æ id')) (stepRes-Ôº† Œìp) = transl-Ctx Œì Œìp , i

  -- ‚¶ã Œµ ‚¶å-Ctx = Œµ
  -- ‚¶ã_‚¶å-Ctx {Œº = Œº} (Œì ‚àô‚üÆ x ‚à£ ŒΩ ‚üØ) = ‚¶ã Œì ‚¶å-Ctx , F-Type (ŒΩ ‚óÜ Œº) (‚¶ã x ‚¶å-Type)
  -- ‚¶ã Œì ‚àô! œâ ‚¶å-Ctx = ‚¶ã Œì ‚¶å-Ctx
             -- -> ‚àë Œª Œ¥ -> ‚àÄ p -> p ‚àà ‚ü® ps ‚ü© -> ‚àÄ{Œî Œîp} -> transl-Ctx Œì Œìp ‚à£ p ‚Ü¶ Œî , Œîp Ctx -> Œî ‚ä¢ ‚¶ã A ‚¶å-Type / Œ¥ GlobalFiber[ p ]

{-
  pre-schedule : ‚àÄ{Œì A i j Œ¥ ps} -> Œì , A Ôº† i ,[ i ] ‚ä¢ A Ôº† j / Œ¥ GlobalFibered[ ps ]
  ‚ü® pre-schedule ‚ü© p x (IR.proj-Ôº† x‚ÇÅ IR.done) (IR.stepRes (Œìp IR., IR.proj-Ôº† x‚ÇÇ IR.done)) = {!!} , {!!} , let B = {!!}
                                                                                                              t = var (res (zero (proj-Ôº† {!!} B)))
                                                                                                            in map-local-project B t -- var (IR.res (zero {!!}))
  ‚ü® pre-schedule ‚ü© p x (IR.proj-Ôº† x‚ÇÅ IR.done) (IR.stepRes (Œìp IR., IR.proj-Ôº† x‚ÇÇ IR.Unit-‚ñ≤)) = {!!} , {!!} , {!!}
  ‚ü® pre-schedule ‚ü© p x (IR.proj-Ôº† x‚ÇÅ IR.done) (IR.stepRes (Œìp IR., IR.proj-Ôº†-‚â† x‚ÇÇ)) = {!!} , {!!} , {!!}
  ‚ü® pre-schedule ‚ü© p x (IR.proj-Ôº† x‚ÇÅ IR.Unit-‚ñ≤) (IR.stepRes (Œìp IR., x‚ÇÇ)) = {!!} , {!!} , {!!}
  -- ‚ü® pre-schedule ‚ü© p x (IR.proj-Ôº† x‚ÇÅ IR.done) (IR.stepRes (Œìp IR., x‚ÇÇ)) = {!!} , {!!} , {!!} -- var (IR.res (zero (proj-Ôº† refl-‚â§ {!!})))
  -- ‚ü® pre-schedule ‚ü© p x (IR.proj-Ôº† x‚ÇÅ IR.Unit-‚ñ≤) (IR.stepRes (Œìp IR., x‚ÇÇ)) = {!!} , {!!} , var (IR.res (zero {!!}))
  ‚ü® pre-schedule ‚ü© p x (proj-Ôº†-‚â† x‚ÇÅ) Œìp = {!!}
  -}

  -- schedule : ‚àÄ{Œì A i j} -> Œì , A Ôº† i ‚ä¢ ‚óª (A Ôº† j) / {!!} GlobalFiber[ {!!} ]
  -- schedule = {!!}

  multibox : ‚àÄ{ŒΩ : ModeHom' ‚óØ ‚ñ≤} -> ‚àÄ{Œì i X ps} -> addRestr ŒΩ (Œì , i) ‚ä¢ X GlobalFibered[ ps ]
             -> Œì ‚ä¢ F-Type ŒΩ X Ôº† i GlobalFibered[ ps ]
  multibox {ŒΩ = `[]` ‚®æ id'} t = box-GlobalFibered t
  multibox {ŒΩ = `[]` ‚®æ `Ôº†` U ‚®æ ŒΩ} t = multibox {ŒΩ = ŒΩ} (box-GlobalFibered t)

  multibox' : ‚àÄ{ŒΩ : ModeHom' ‚óØ ‚óØ} -> ‚àÄ{Œì X ps} -> addRestr ŒΩ Œì ‚ä¢ X GlobalFibered[ ps ]
             -> Œì ‚ä¢ F-Type ŒΩ X GlobalFibered[ ps ]
  multibox' {ŒΩ = id'} t = t
  multibox' {ŒΩ = `[]` ‚®æ `Ôº†` U ‚®æ ŒΩ} t = multibox' {ŒΩ = ŒΩ} (box-GlobalFibered t)

  -- transl-Var : ‚àÄ{œâ : ModeHom' ‚óØ ‚óØ} {Œì : CtxExt œâ} {ps Œìp} {A : ‚ä¢Type ‚óØ} -> (Œµ ‚ãÜ Œì) ‚ä¢Var‚üÆ A ‚à£ Œº ‚áí Œ∑ ‚üØ -> transl-Ctx Œì Œìp ‚ä¢ ‚¶ã A ‚¶å-Type GlobalFibered[ ps ]
  -- transl-Var {Œì = Œì ‚àô‚üÆ x ‚à£ Œº ‚üØ} zero = {!!}
  -- transl-Var {Œì = Œì ‚àô‚üÆ x ‚à£ Œº ‚üØ} (suc v) = {!!}
  -- transl-Var {Œì = Œì ‚àô! œâ} v = {!!}

  -- transl-Mod : ModeHom' ‚ñ≤ ‚óØ -> ((ùí´·∂†‚Å±‚Åø (Proc œÅ)) √ó-ùí∞ List (ùí´·∂†‚Å±‚Åø (Proc œÅ)))
  -- transl-Mod = {!!}

  -- transl-Mod : ModeHom' ‚óØ ‚óØ -> (List (ùí´·∂†‚Å±‚Åø (Proc œÅ)))
  -- transl-Mod œâ = {!!}

  transl-Mod : ModeHom' ‚óØ ‚óØ -> (List (ùí´·∂†‚Å±‚Åø (Proc œÅ)))
  transl-Mod id' = []
  transl-Mod (`[]` ‚®æ `Ôº†` U ‚®æ œâ) = U ‚à∑ transl-Mod œâ

  transl-Mod-rec : ModeHom' ‚óØ ‚óØ -> (List (ùí´·∂†‚Å±‚Åø (Proc œÅ))) -> (List (ùí´·∂†‚Å±‚Åø (Proc œÅ)))
  transl-Mod-rec id' xs = xs
  transl-Mod-rec (`[]` ‚®æ `Ôº†` U ‚®æ œâ) xs = transl-Mod-rec œâ (U ‚à∑ xs)


  transl-Mod' : ModeHom' ‚óØ ‚óØ -> (List (ùí´·∂†‚Å±‚Åø (Proc œÅ)))
  transl-Mod' œâ = transl-Mod-rec œâ []

  -- map-restr : ‚àÄ{Œì B} -> Œì ‚ä¢Var B GlobalFiber[ transl-Mod Œ∑ ]
  --                  -> addRestr œâ Œì ‚ä¢Var B GlobalFiber[ transl-Mod (œâ ‚óÜ' Œ∑) ]
  -- map-restr {œâ = id'} v = v
  -- map-restr {œâ = `[]` ‚®æ `Ôº†` U ‚®æ œâ} v = let zz = map-restr {œâ = œâ} v in {!!}

  -- add-restr-var : Œì ‚ä¢Var B GlobalFiber[ ps ] -> Œì ,[ U ] ‚ä¢Var B GlobalFiber

  cons : ‚àÄ{A : ùí∞ ùëô} -> A √ó List A -> List A
  cons (a , as) = a ‚à∑ as


  postpend : ‚àÄ{A : ùí∞ ùëô} -> (List A) -> A -> A √ó List A
  postpend [] x = x , []
  postpend (x ‚à∑ xs) z = x , cons (postpend xs z)

  rev' : ‚àÄ{A : ùí∞ ùëô} -> List A -> List A
  rev' [] = []
  rev' (x ‚à∑ xs) = cons (postpend (rev' xs) x)


{-
  map-restr : ‚àÄ{Œì B ps} -> Œì ‚ä¢Var B GlobalFiber[ (rev (transl-Mod œâ)) <> ps ]
                   -> addRestr œâ Œì ‚ä¢Var B GlobalFiber[ ps ]
  map-restr {œâ = id'} v = v
  map-restr  {œâ = (`[]` ‚®æ `Ôº†` U ‚®æ œâ)} {Œì = Œì} {B} {ps} v =
    let v‚ÇÄ : Œì ‚ä¢Var B GlobalFiber[(rev (transl-Mod œâ) ++-List ( U ‚à∑ [] )) ++-List ps ]
        v‚ÇÄ = v

        p‚ÇÄ : (rev (transl-Mod œâ) ++-List ( U ‚à∑ [] )) ++-List ps ‚â°  rev (transl-Mod œâ) ++-List (( U ‚à∑ [] ) ++-List ps) 
        p‚ÇÄ = {!!}

        v‚ÇÅ : Œì ‚ä¢Var B GlobalFiber[ rev (transl-Mod œâ) ++-List (( U ‚à∑ [] ) ++-List ps) ]
        v‚ÇÅ = transp (cong-‚â° (Œª Œæ -> Œì ‚ä¢Var B GlobalFiber[ Œæ ]) p‚ÇÄ) v‚ÇÄ

        v'' = map-restr {œâ = œâ} v‚ÇÅ

    in res v''

  map-restr' : ‚àÄ{Œì B p} -> Œì ‚ä¢Var B GlobalFiber[ (rev' (p ‚à∑ (transl-Mod œâ))) ]
                   -> addRestr œâ Œì ‚ä¢Var B GlobalFiber[ p ‚à∑ [] ]
  map-restr' = {!!}

-}


{-
  transl-Var : ‚àÄ{œâ : ModeHom' a ‚óØ} (Œì : CtxExt œâ) -> ‚àÄ Œìp -> {X : ‚ä¢Type ‚óØ}
               -> (Œµ ‚ãÜ Œì) ‚ä¢Var‚üÆ X ‚à£ Œº ‚áí Œ∑ ‚üØ
               -- -> ‚àÄ{A p} -> ‚àÄ (ŒΩ : ModeHom' ‚óØ a) -> œÄ ‚¶ã X ‚¶å-Type ‚à£ p , transl-Mod (ŒΩ ‚óÜ' Œ∑) ‚Ü¶ A Type
               -> ‚àÄ{A p} -> ‚àÄ (ŒΩ : ModeHom' ‚óØ a) -> œÄ F-Type Œº ‚¶ã X ‚¶å-Type ‚à£ postpend (rev' (transl-Mod (ŒΩ ‚óÜ' Œ∑))) p ‚Ü¶ A Type
               -> ‚àÄ{B} -> œï A ‚Ü¶ B
               -> addRestr ŒΩ (transl-Ctx Œì Œìp) ‚ä¢Var B GlobalFiber[ p ‚à∑ [] ]
  transl-Var (Œì ‚àô‚üÆ A ‚à£ Œº ‚üØ) (stepVar Œìp) zero ŒΩ Xp Fp = map-restr' {œâ = ŒΩ} (zero Xp Fp)
  transl-Var (Œì ‚àô‚üÆ A ‚à£ Œº ‚üØ) (stepVar Œìp) (suc x) ŒΩ Xp Fp = {!!}
  -- transl-Var (_‚àô!_ {‚ñ≤} Œì œâ) (stepRes Œìp) (suc! x) ŒΩ = {!!}
  transl-Var (_‚àô!_ Œì œâ) (stepRes Œìp) (suc! x) ŒΩ Xp Fp =
    let xx = transl-Var Œì Œìp x (ŒΩ ‚óÜ' œâ) Xp Fp
    in {!!}

  transl-Var' : ‚àÄ{œâ : ModeHom' ‚óØ ‚óØ} (Œì : CtxExt œâ) -> ‚àÄ Œìp -> {X : ‚ä¢Type ‚óØ}
               -> (Œµ ‚ãÜ Œì) ‚ä¢Var‚üÆ X ‚à£ Œº ‚áí Œ∑ ‚üØ
               -- -> ‚àÄ{A p} -> ‚àÄ (ŒΩ : ModeHom' ‚óØ a) -> œÄ ‚¶ã X ‚¶å-Type ‚à£ p , transl-Mod (ŒΩ ‚óÜ' Œ∑) ‚Ü¶ A Type
               -> ‚àÄ{A p} -> œÄ F-Type Œº ‚¶ã X ‚¶å-Type ‚à£ postpend (rev' (transl-Mod (Œ∑))) p ‚Ü¶ A Type
               -> ‚àÄ{B} -> œï A ‚Ü¶ B
               -> transl-Ctx Œì Œìp ‚ä¢Var B GlobalFiber[ p ‚à∑ [] ]

  transl-Var' Œì Œìp v Xp Xq = transl-Var Œì Œìp v id' Xp Xq



  make-œÄ : ‚àÄ (Œº : ModeHom' ‚óØ ‚óØ) X p -> ‚àë Œª A -> œÄ F-Type Œº ‚¶ã X ‚¶å-Type ‚à£ postpend (rev' (transl-Mod Œ∑)) p ‚Ü¶ A Type
                                       √ó-ùí∞ œï A ‚Ü¶ œÄ-Type ‚¶ã X ‚¶å-Type (p , [])
  make-œÄ Œº = {!!}

  -- make-œÄ-id : ‚àÄ (Œº : ModeHom' ‚óØ ‚óØ) X p -> ‚àë Œª A -> œÄ F-Type Œº ‚¶ã X ‚¶å-Type ‚à£ postpend (rev' (transl-Mod Œº)) p ‚Ü¶ A Type
  --                                      √ó-ùí∞ œï A ‚Ü¶ œÄ-Type ‚¶ã X ‚¶å-Type {!!} (p , [])
  -- make-œÄ-id id' X p = œÄ-Type ‚¶ã X ‚¶å-Type {!!} (p , []) , {!!}
  -- make-œÄ-id (`[]` ‚®æ `Ôº†` U ‚®æ Œº) X p =
  --   let A' , Ap , Aq = make-œÄ-id Œº X p
  --   in {!!}


  skip-step : ‚àÄ X U -> ‚àÄ{r rs} -> œï œÄ-Type (‚óª X Ôº† U) (U , (r ‚à∑ rs)) ‚Ü¶ œÄ-Type X (r , rs)
  skip-step X U with decide-‚â§ U U
  ... | no x = ‚ä•-elim (x refl-‚â§)
  ... | yes x = proj-Ôº†

  fmap-step : ‚àÄ{X r rs Y u us} -> œï œÄ-Type X (r , rs) ‚Ü¶ œÄ-Type Y (u , us)
              -> œï œÄ-Type (F-Type Œº X) (r , rs) ‚Ü¶ œÄ-Type (F-Type Œº Y) (u , us)
  fmap-step {Œº = id'} {X = X} {r} {rs} {Y} {u} {us} = {!!}
  fmap-step {Œº = (`[]` ‚®æ `Ôº†` U ‚®æ Œº)} {X = X} {r} {rs} {Y} {u} {us} v = fmap-step {Œº = Œº} {!!}


  _‚óÜ-œï_ : ‚àÄ{A B C : Type ‚ñ≤} -> œï A ‚Ü¶ B -> œï B ‚Ü¶ C -> œï A ‚Ü¶ C
  _‚óÜ-œï_ = {!!}

{-
  make-œÄ-id : ‚àÄ (Œº : ModeHom' ‚óØ ‚óØ) X p -> œï œÄ-Type (F-Type Œº ‚¶ã X ‚¶å-Type) {!!} (postpend (rev' (transl-Mod Œº)) p)
                                          ‚Ü¶ œÄ-Type ‚¶ã X ‚¶å-Type {!!} (p , [])
  make-œÄ-id id' X p = id-œï
  make-œÄ-id (`[]` ‚®æ `Ôº†` U ‚®æ Œº) X p =
    let Ap : œï œÄ-Type (F-Type Œº ‚¶ã X ‚¶å-Type) {!!} (postpend (rev' (transl-Mod Œº)) p) ‚Ü¶ œÄ-Type ‚¶ã X ‚¶å-Type {!!} (p , [])
        Ap = make-œÄ-id Œº X p

        Bp : œï œÄ-Type (‚óª (F-Type Œº ‚¶ã X ‚¶å-Type) Ôº† U) (‚óª {!!} Ôº† U) (U , cons ((postpend (rev' (transl-Mod Œº)) p))) ‚Ü¶ œÄ-Type (F-Type Œº ‚¶ã X ‚¶å-Type) {!!} (postpend (rev' (transl-Mod Œº)) p)
        Bp = skip-step (F-Type Œº ‚¶ã X ‚¶å-Type) {!!} U

        Bp' : œï œÄ-Type (‚óª (‚¶ã X ‚¶å-Type) Ôº† U) (‚óª {!!} Ôº† U) (U , cons ((postpend (rev' (transl-Mod Œº)) p))) ‚Ü¶ œÄ-Type (‚¶ã X ‚¶å-Type) {!!} (postpend (rev' (transl-Mod Œº)) p)
        Bp' = skip-step (‚¶ã X ‚¶å-Type) {!!} U

        Bp'2 : œï œÄ-Type (‚óª (‚¶ã X ‚¶å-Type) Ôº† U) (‚óª {!!} Ôº† U) (((postpend (rev' (transl-Mod (`[]` ‚®æ `Ôº†` U ‚®æ Œº))) p))) ‚Ü¶ œÄ-Type (‚¶ã X ‚¶å-Type) {!!} (postpend (rev' (transl-Mod Œº)) p)
        Bp'2 = {!!} -- skip-step (‚¶ã X ‚¶å-Type) {!!} U

        Bp'' : œï œÄ-Type (F-Type Œº (‚óª (‚¶ã X ‚¶å-Type) Ôº† U)) {!!} (U , cons ((postpend (rev' (transl-Mod Œº)) p))) ‚Ü¶ œÄ-Type (F-Type Œº ‚¶ã X ‚¶å-Type) {!!} (postpend (rev' (transl-Mod Œº)) p)
        Bp'' = fmap-step {Œº = Œº} Bp'
    in  {!Bp''!} ‚óÜ-œï {!!}

-}



  cong‚ÇÅ-œï : ‚àÄ{a} -> ‚àÄ{A B C : Type a} -> A ‚â° B -> œï A ‚Ü¶ C -> œï B ‚Ü¶ C
  cong‚ÇÅ-œï refl-‚â° x = x

  make-œÄ-id-ind : ‚àÄ (Œº : ModeHom' ‚óØ ‚óØ) X p -> œï œÄ-Type (F-Type (ŒΩ ‚óÜ Œº) ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod (ŒΩ ‚óÜ Œº))) p)
                                          ‚Ü¶ œÄ-Type (F-Type ŒΩ ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod (ŒΩ))) p)
  make-œÄ-id-ind id' X p = id-œï
  make-œÄ-id-ind {ŒΩ = ŒΩ} (`[]` ‚®æ `Ôº†` U ‚®æ Œº) X p =
    let Ap = make-œÄ-id-ind {ŒΩ = ŒΩ ‚óÜ `[]` ‚®æ `Ôº†` U ‚®æ id'} Œº X p

        Bp‚ÇÄ : œï œÄ-Type (F-Type (`[]` ‚®æ `Ôº†` U ‚®æ id') (F-Type ŒΩ ‚¶ã X ‚¶å-Type)) (U , cons (postpend (rev' (transl-Mod ŒΩ)) p))
              ‚Ü¶ œÄ-Type (F-Type ŒΩ ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod (ŒΩ))) p)
        Bp‚ÇÄ = skip-step (F-Type ŒΩ ‚¶ã X ‚¶å-Type) U

        p‚ÇÄ : (F-Type (`[]` ‚®æ `Ôº†` U ‚®æ id') (F-Type ŒΩ ‚¶ã X ‚¶å-Type)) ‚â° (F-Type (ŒΩ ‚óÜ `[]` ‚®æ `Ôº†` U ‚®æ id') ‚¶ã X ‚¶å-Type)
        p‚ÇÄ = sym-‚â° (F-Type-map {X = ‚¶ã X ‚¶å-Type} {Œº = ŒΩ} {ŒΩ = (`[]` ‚®æ `Ôº†` U ‚®æ id')})

        p‚ÇÅ : U , cons (postpend (rev' (transl-Mod ŒΩ)) p) ‚â° postpend (rev' (transl-Mod (ŒΩ ‚óÜ' `[]` ‚®æ `Ôº†` U ‚®æ id'))) p
        p‚ÇÅ = {! !}

        Bp : œï œÄ-Type (F-Type (ŒΩ ‚óÜ `[]` ‚®æ `Ôº†` U ‚®æ id') ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod (ŒΩ ‚óÜ (`[]` ‚®æ `Ôº†` U ‚®æ id')))) p)
            ‚Ü¶ œÄ-Type (F-Type ŒΩ ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod (ŒΩ))) p)
        Bp = cong‚ÇÅ-œï (cong-‚â° (Œª Œæ -> œÄ-Type Œæ (U , cons (postpend (rev' (transl-Mod ŒΩ)) p))) p‚ÇÄ
                     ‚àô-‚â° cong-‚â° (Œª Œæ -> œÄ-Type (F-Type (ŒΩ ‚óÜ `[]` ‚®æ `Ôº†` U ‚®æ id') ‚¶ã X ‚¶å-Type) Œæ) p‚ÇÅ) Bp‚ÇÄ

    in Ap ‚óÜ-œï Bp

-}


{-
  make-œÄ-under-ind : ‚àÄ (Œº ŒΩ œâ : ModeHom' ‚óØ ‚óØ) X p -> ‚àÄ{C}
                       -> œï œÄ-Type (F-Type ŒΩ ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod œâ)) p) ‚Ü¶ C

                       -> œï œÄ-Type (F-Type (ŒΩ ‚óÜ Œº) ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod (œâ ‚óÜ Œº))) p) ‚Ü¶ C

  make-œÄ-under-ind id' ŒΩ œâ X p P = P
  make-œÄ-under-ind (`[]` ‚®æ `Ôº†` U ‚®æ Œº) ŒΩ œâ X p PP =
    let Ap = make-œÄ-under-ind Œº (ŒΩ ‚óÜ `[]` ‚®æ `Ôº†` U ‚®æ id') (œâ ‚óÜ `[]` ‚®æ `Ôº†` U ‚®æ id') X p {!!}

        -- Bp‚ÇÄ : œï œÄ-Type (F-Type (`[]` ‚®æ `Ôº†` U ‚®æ id') (F-Type ŒΩ ‚¶ã X ‚¶å-Type)) (U , cons (postpend (rev' (transl-Mod ŒΩ)) p))
        --       ‚Ü¶ œÄ-Type (F-Type ŒΩ ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod (ŒΩ))) p)
        -- Bp‚ÇÄ = skip-step (F-Type ŒΩ ‚¶ã X ‚¶å-Type) U

        -- p‚ÇÄ : (F-Type (`[]` ‚®æ `Ôº†` U ‚®æ id') (F-Type ŒΩ ‚¶ã X ‚¶å-Type)) ‚â° (F-Type (ŒΩ ‚óÜ `[]` ‚®æ `Ôº†` U ‚®æ id') ‚¶ã X ‚¶å-Type)
        -- p‚ÇÄ = sym-‚â° (F-Type-map {X = ‚¶ã X ‚¶å-Type} {Œº = ŒΩ} {ŒΩ = (`[]` ‚®æ `Ôº†` U ‚®æ id')})

        -- p‚ÇÅ : U , cons (postpend (rev' (transl-Mod ŒΩ)) p) ‚â° postpend (rev' (transl-Mod (ŒΩ ‚óÜ' `[]` ‚®æ `Ôº†` U ‚®æ id'))) p
        -- p‚ÇÅ = {! !}

        -- Bp : œï œÄ-Type (F-Type (ŒΩ ‚óÜ `[]` ‚®æ `Ôº†` U ‚®æ id') ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod (ŒΩ ‚óÜ (`[]` ‚®æ `Ôº†` U ‚®æ id')))) p)
        --     ‚Ü¶ œÄ-Type (F-Type ŒΩ ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod (ŒΩ))) p)
        -- Bp = cong‚ÇÅ-œï (cong-‚â° (Œª Œæ -> œÄ-Type Œæ (U , cons (postpend (rev' (transl-Mod ŒΩ)) p))) p‚ÇÄ
        --              ‚àô-‚â° cong-‚â° (Œª Œæ -> œÄ-Type (F-Type (ŒΩ ‚óÜ `[]` ‚®æ `Ôº†` U ‚®æ id') ‚¶ã X ‚¶å-Type) Œæ) p‚ÇÅ) Bp‚ÇÄ

    in Ap ‚óÜ-œï {!!}

-}

  local-var-impossible : ‚àÄ{a b c A} {Œì : Ctx a} -> (Œìp : isCtx‚ÇÇ Œì) -> {Œº : ModeHom' b ‚ñ≤} {Œ∑ : ModeHom' c ‚ñ≤} -> Œì ‚ä¢Var‚üÆ A ‚à£ Œº ‚áí Œ∑ ‚üØ -> ùüò-ùí∞
  local-var-impossible (stepRes Œìp) (suc! v) = local-var-impossible Œìp v
  local-var-impossible (stepVar Œìp) (suc v) = local-var-impossible Œìp v



{-
  make-œÄ-id : ‚àÄ (Œº : ModeHom' ‚óØ ‚óØ) X p -> œï œÄ-Type (F-Type (Œº) ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod Œº)) p)
                                          ‚Ü¶ œÄ-Type (‚¶ã X ‚¶å-Type) (p , [])
  make-œÄ-id Œº X p = make-œÄ-id-ind {ŒΩ = id} Œº X p

  make-œÄ-broadcast : ‚àÄ X U p -> œï œÄ-Type (‚óª ‚¶ã X ‚¶å-Type Ôº† U) (p , []) ‚Ü¶ œÄ-Type (‚¶ã X ‚¶å-Type) (p , [])
  make-œÄ-broadcast = {!!}

  make-œÄ-prepare : ‚àÄ A U V p -> œï œÄ-Type (‚óª ‚¶ã A ‚¶å-Type Ôº† U) (U , (V ‚à∑ p ‚à∑ [])) ‚Ü¶ œÄ-Type (‚¶ã A ‚¶å-Type) (p , [])
  make-œÄ-prepare A U V p with decide-‚â§ U U
  ... | no x = {!!}
  ... | yes x = proj-‚óª ‚óÜ-œï proj-Ôº†

  make-œÄ-prepare' : ‚àÄ X p (U V : ùí´·∂†‚Å±‚Åø (Proc œÅ)) -> œï œÄ-Type (F-Type (id' ‚óÜ (`[]` ‚®æ `Ôº†` U ‚®æ id')) ‚¶ã X ‚¶å-Type) (postpend (rev' (transl-Mod ((`[]` ‚®æ `Ôº†` V ‚®æ `[]` ‚®æ id') ‚óÜ (`Ôº†` U ‚®æ id')))) p)
                                                   ‚Ü¶ œÄ-Type (‚¶ã X ‚¶å-Type) (p , [])
  make-œÄ-prepare' X p U V = make-œÄ-prepare X U V p

-}


{-
-}

  transl-Var : ‚àÄ{œâ : ModeHom' ‚óØ ‚óØ} (Œì : CtxExt œâ) -> ‚àÄ Œìp -> {X : ‚ä¢Type ‚óØ}
               -> (Œµ ‚ãÜ Œì) ‚ä¢Var‚üÆ X ‚à£ Œº ‚áí Œ∑ ‚üØ
               -- -> ‚àÄ{A p} -> ‚àÄ (ŒΩ : ModeHom' ‚óØ a) -> œÄ ‚¶ã X ‚¶å-Type ‚à£ p , transl-Mod (ŒΩ ‚óÜ' Œ∑) ‚Ü¶ A Type
               -- -> ‚àÄ{A p} -> ‚àÄ (ŒΩ : ModeHom' ‚óØ a) -> œÄ F-Type Œº ‚¶ã X ‚¶å-Type ‚à£ postpend (rev' (transl-Mod (ŒΩ ‚óÜ' Œ∑))) p ‚Ü¶ A Type
               -- -> ‚àÄ{B} -> œï A ‚Ü¶ B
               -> ‚àÄ{p Œî B}
               -> œÄ ‚¶ã X ‚¶å-Type ‚à£ p , [] ‚Ü¶ B Type
               -> (transl-Ctx Œì Œìp) ‚à£ p ‚à∑ [] ‚Ü¶ Œî Ctx
               -> Œî ‚ä¢Var B GlobalFiber[ p ‚à∑ [] ]
  transl-Var (Œì Definition-MTTÍü≥.‚àô‚üÆ x ‚à£ Œº ‚üØ) Œìp Definition-MTTÍü≥.zero Xp Œìpp = {!!}
  transl-Var (Œì Definition-MTTÍü≥.‚àô‚üÆ x ‚à£ Œº ‚üØ) Œìp (Definition-MTTÍü≥.suc v) Xp Œìpp = {!!}
  transl-Var (Œì Definition-MTTÍü≥.‚àô! œâ) Œìp (Definition-MTTÍü≥.suc! v) Xp Œìpp = {!!}


{-

  mutual
    {-# TERMINATING #-} -- NOTE: Agda does not see that the letmod case terminates
    transl-Term-‚ñ≤ : ‚àÄ{ps i} -> ‚àÄ{Œº : ModeHom' ‚óØ ‚óØ} -> (Œì : CtxExt Œº) -> (Œìp : isCtx‚ÇÇ (Œµ ‚ãÜ Œì))
              -> ‚àÄ{A} -> Œµ ‚ãÜ Œì ‚àô! (`Ôº†` i ‚®æ id') ‚ä¢ A
              -> transl-Ctx Œì Œìp  ‚ä¢ (‚¶ã A ‚¶å-Type Ôº† i) GlobalFibered[ ps ]
    transl-Term-‚ñ≤ Œì Œìp (var x [ incl Œ±‚ÇÄ ‚à£ incl Œ±‚ÇÅ ]) =
      let Œ±‚ÇÄ' = linearize Œ±‚ÇÄ
          Œ±‚ÇÅ' = linearize Œ±‚ÇÅ
      -- in {!!}
      in {!!} --  IR.incl (Œª p x‚ÇÅ Xp Œìp‚ÇÅ ‚Üí var (transl-Var Œì Œìp x Xp Œìp‚ÇÅ))
    transl-Term-‚ñ≤ Œì Œìp tt = {!!}
    transl-Term-‚ñ≤ Œì Œìp (mod `[]` t) = {!!}
      -- let Œ¥' , ts' = transl-Term-‚óØ _ (stepRes-‚óª (stepRes-Ôº† Œìp)) t
      -- in _ , box-GlobalFibered ts'
    transl-Term-‚ñ≤ Œì Œìp (letmod' `[]` t s) =
      let t' = transl-Term-‚ñ≤ _ Œìp t
          s' = transl-Term-‚ñ≤ _ (stepVar Œìp) (shift-Ôº† (id-annotate s))
      in letin-GlobalFibered t' s'
    transl-Term-‚ñ≤ Œì Œìp (letmod (`Ôº†` U) ŒΩ t s) =

      let t' = transl-Term-‚óØ _ (stepRes (stepRes Œìp)) t
          s' = transl-Term-‚ñ≤ _ (stepVar Œìp) (shift-Ôº† (id-annotate s))
      in letin-GlobalFibered (multibox t') s'
    transl-Term-‚ñ≤ Œì Œìp (letmod `[]` id' t s) = {!!}
    transl-Term-‚ñ≤ Œì Œìp (letmod `[]` (`Ôº†` U ‚®æ ŒΩ) t s) =
      let t' = split-path t

          t'' = transl-Term-‚ñ≤ _ (stepRes (stepRes Œìp)) t'
          s' = transl-Term-‚ñ≤ _ (stepVar Œìp) (shift-Ôº† (id-annotate s))

      in letin-GlobalFibered (multibox t'') s'
    transl-Term-‚ñ≤ Œì Œìp (trans x xP t) = {!!}
    transl-Term-‚ñ≤ Œì Œìp (pure t) = {!!}
    transl-Term-‚ñ≤ Œì Œìp (seq t t‚ÇÅ) = {!!}
    transl-Term-‚ñ≤ Œì Œìp (lam t) =
      let t' = shift-Ôº† t
          rest' = transl-Term-‚ñ≤ _ (stepVar Œìp) t'
      in commute-Ôº†-Exp _ (lam-GlobalFibered rest')
    transl-Term-‚ñ≤ Œì Œìp (app t t‚ÇÅ) = {!!}


    transl-Term-‚óØ : ‚àÄ{ps} -> ‚àÄ{Œº : ModeHom' ‚óØ ‚óØ} -> (Œì : CtxExt Œº) -> (Œìp : isCtx‚ÇÇ (Œµ ‚ãÜ Œì))
              -> ‚àÄ{A} -> Œµ ‚ãÜ Œì ‚ä¢ A
              -> transl-Ctx Œì Œìp  ‚ä¢ ‚¶ã A ‚¶å-Type GlobalFibered[ ps ]
    transl-Term-‚óØ Œì Œìp (var {b = ‚ñ≤} x [ incl Œ±‚ÇÄ ‚à£ incl Œ±‚ÇÅ ]) = ‚ä•-elim (local-var-impossible Œìp x)
    transl-Term-‚óØ Œì Œìp (var {b = ‚óØ} x [ incl Œ±‚ÇÄ ‚à£ incl Œ±‚ÇÅ ]) =
      let Œ±‚ÇÄ' = linearize Œ±‚ÇÄ
          Œ±‚ÇÅ' = linearize Œ±‚ÇÅ
          -- xx = transl-Var' Œì Œìp x {!!} {!!}
      in IR.incl (Œª p x‚ÇÅ Xp Œìp‚ÇÅ ‚Üí var (transl-Var Œì Œìp x Xp Œìp‚ÇÅ))
    transl-Term-‚óØ Œì Œìp tt = {!!}
    transl-Term-‚óØ Œì Œìp (mod (`Ôº†` U) t) =
      let t' = transl-Term-‚ñ≤ _ Œìp t
      in t'
    transl-Term-‚óØ Œì Œìp (letmod (`Ôº†` U) ŒΩ t s) =
      let t' = transl-Term-‚óØ _ (stepRes Œìp) t
          s' = transl-Term-‚óØ _ (stepVar Œìp) s
      in letin-GlobalFibered (multibox' t') s'
      -- in _ , letin-GlobalFibered t' s'
    transl-Term-‚óØ Œì Œìp (letmod `[]` (`Ôº†` i ‚®æ ŒΩ) t s) =
      let t' = split-path t

          t'' = transl-Term-‚ñ≤ _ (stepRes Œìp) t'

          s' = transl-Term-‚óØ _ (stepVar Œìp) s
      in letin-GlobalFibered (multibox' t'') s'

    transl-Term-‚óØ Œì Œìp (letmod' Œº t t‚ÇÅ) = {!Œº!}
    transl-Term-‚óØ Œì Œìp (trans .([ incl [] ‚à£ incl (incl (id' ‚åü[ recv _ ]‚åû id' ‚åü) ‚à∑ []) ]) br t) =
      let t' = transl-Term-‚óØ _ Œìp t
      in broadcast-GlobalFibered t'
    transl-Term-‚óØ Œì Œìp (pure t) = {!!}
    transl-Term-‚óØ Œì Œìp (seq t t‚ÇÅ) = {!!}
    transl-Term-‚óØ Œì Œìp (lam t) =
      let t' = transl-Term-‚óØ _ (stepVar Œìp) t
      in lam-GlobalFibered t'
    transl-Term-‚óØ Œì Œìp (app t s) =
      let t' = transl-Term-‚óØ _ Œìp t
          s' = transl-Term-‚óØ _ Œìp s
      in app-GlobalFibered t' s'



-}










